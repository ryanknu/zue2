var debounce=function(e,t,n){var i;return function o(){var o=this,a=arguments;function s(){if(!n)e.apply(o,a);i=null}if(i)clearTimeout(i);else if(n)e.apply(o,a);i=setTimeout(s,t||100)}};var hoodie=new Hoodie;var sortGroups=function(){var e="#lights";$(e+" > div").sort(function(e,t){return $(e).data("model").type==="group"?-1:1}).appendTo($(e))};function saveLight(e){var t=new Color(e);var n=$("#light_"+e.getId());repoopulate(n,e);junctions();n.find("[name=ct]:not([init])").on("change",debounce(function(){getLight(this).setK($(this).val())},250));n.find("[name=bri]:not([init])").on("change",debounce(function(){getLight(this).setBri(parseInt($(this).val(),10))},250));n.find("input").attr("init","1");var i=e.state.reachable&&e.state.on?t:"OFF";$("#"+e.getId()).show().data("model",e).find(".name").text(e.name).end().find(".state_hue").text(i).css("color",t.getCss()).end();if(!e.state.reachable){$("#"+e.getId()).hide()}showNoLightsAvailable()}function showNoLightsAvailable(){$("#all-off").hide();if($("#lights > :visible").length<1){$("#all-off").show()}}function getLight(e){return $(e).closest(".ILightControl").data("model")}function safeMacAddress(e){return e.replace(/:/g,"")}function getAllLights(e){poopulate("#IBridgeControl","#bridges",e).attr("mac-safe",safeMacAddress(e.macaddress)).addClass("working").find("a.configure").on("click",function(){var e=$(this).closest(".IBridgeControl").data("model");poopulate("#bridge-config","body",e).modal()}).end();zue.lights.getAllLights(e)}function stopWorking(e){$(".IBridgeControl[mac-safe="+safeMacAddress(e.macaddress)+"]").removeClass("working")}function hoodieStore(e){console.log(JSON.stringify(e));hoodie.store.add("bridge",JSON.parse(JSON.stringify(e))).done(function(e){zue.log("added: "+JSON.stringify(e))})}function resolveKey(e,t){if(t){var n=t.split(".");var i=e;var o=i;for(var a=0;a<n.length;++a){if(i===undefined){break}o=i;i=i[n[a]]}if(typeof i==="function"){i=i.call(o)}return i}}function repoopulate(e,t){e.find("*").each(function(){var e=$(this).data("modelkey");$(this).text(resolveKey(t,e))})}function poopulate(e,t,n){var o=$(e).clone();o.removeAttr("id").data("model",n);o.find("*").each(function(){var e=$(this).data("modelkey");$(this).text(resolveKey(n,e))});for(i in n){if(typeof n[i]==="function"){continue}var a=o.find("."+i);a.each(function(){if($(this).is("input")){$(this).val(n[i])}else{$(this).text(n[i])}})}$(t).append(o);return o}zue.enablePlugin("SimulateGroupsByNames");zue.on(HUE_ERROR,function(e){if(e.type==ERR_UNAUTHORIZED){createLinkButton(e.bridge)}else if(e.type!=ERR_LINK_BUTTON_NOT_PRESSED){$("#hue-exception").modal();console.log(JSON.stringify(e))}});zue.on(BRIDGE_FOUND,function(e){hoodieStore(e);getAllLights(e)});zue.on(LIGHT_ADDED,function(e){stopWorking(e.bridge);if($("#"+e.getId()).length<1){poopulate("#ILightControl","#lights",e).attr("id",e.getId()).find(".toggle").on("click",function(){getLight(this).toggle()}).end().find(".setHue").on("click",function(){getLight(this).setHue(parseInt(prompt("hue"),10))}).end().find(".name").wrap($("<a zue/>").attr("href","light/"+e.getId())).end();poopulate("#light-control-pallete","#content-zone",e).attr("id","light_"+e.getId());zueLinks();if(e.simple){zue.lights.getLightDetails(e)}}else{saveLight(e)}});zue.on(LIGHT_UPDATING,function(e){$("#"+e.getId()).addClass("working")});zue.on(LIGHT_UPDATED,function(e){$("#"+e.getId()).removeClass("working");saveLight(e)});zue.on(GROUP_ADDED,function(e){poopulate("#ILightControl","#groups",e).attr("id",e.getId()).find("no-group").hide()});zue.on(HUE_ERROR,function(e){if(e.type==ERR_LINK_BUTTON_NOT_PRESSED){if(e.bridge.linking){setTimeout(function(){createUser(e.bridge)},5e3)}}});zue.on(LINKED,function(e){$("input[type=button]").each(function(){if($(this).attr("mac")==e.macaddress){$(this).parent().remove()}});hoodieStore(e);getAllLights(e)});zue.on(NO_BRIDGE_FOUND,function(){$("#no-bridge").modal()});var createUser=function(e){zue.config.createAnonUser(e,"web application")};function createLinkButton(e){var t=$("#link-section").clone();t.find("input[type=button]").attr("mac",e.macaddress).data("bridge",e).val("Link "+e.macaddress).on("click",function(){var e=$(this).data("bridge");if(!e.linking){e.linking=true;$(this).val("Cancel "+e.macaddress);createUser(e)}else{e.linking=false;$(this).val("Link "+e.macaddress)}});$(".col-md-3").prepend(t);t.fadeIn()}function zueLinks(){var e=function(){mainContentArea($(this).data("tag"))};$("a[zue][href]").each(function(){var t=$(this).attr("href");$(this).css("cursor","pointer");$(this).removeAttr("href");$(this).data("tag",t);$(this).on("click",e)})}function mainContentArea(e){$("#content-zone > div").hide();$z=$("#"+e.replace("/","_"));if($z.length>0&&e!="nothing-selected"){$z.show();location.hash="/"+e}else{$("#nothing-selected").show();location.hash="/"}}function junctions(){$(".junction").each(function(){var e=$(this).find("[data-jswitch]");var t=e.val()||e.text();e=undefined;$(this).find("[data-jif]").each(function(){if($(this).data("jif").toString()==t.toString()){$(this).show()}else{$(this).hide()}})})}(function(){"use strict";hoodie.store.findAll("bridge").then(function(e){console.log(JSON.stringify(e));if(e.length<1){zue.bridge.locate();return}for(var t=0;t<e.length;t++){var n=new Bridge;n.exchangeData(e[t]);getAllLights(n)}});var e=$("#nothing-selected").parent().height();$("#nothing-selected").css("height",e+"px");zueLinks();if(location.hash.length>2){mainContentArea(location.hash.replace(/[\#\/]/g,""))}else{mainContentArea("nothing-selected")}})();